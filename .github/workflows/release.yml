name: åˆ›å»º Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: '1.18'

      - name: è¿è¡Œæµ‹è¯•
        run: go test -v ./...

      - name: è·å–æ ‡ç­¾ä¿¡æ¯
        id: tag_info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          # è·å–æ ‡ç­¾æ³¨é‡Šä¿¡æ¯
          TAG_MESSAGE=$(git tag -l --format='%(contents)' $TAG_NAME)
          echo "tag_message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆ Release è¯´æ˜
        id: release_notes
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          TAG_MESSAGE="${{ steps.tag_info.outputs.tag_message }}"

          # åˆ›å»º Release è¯´æ˜
          cat > release_notes.md << 'EOF'
          ## ğŸ‰ Go Easy SMS ${{ steps.tag_info.outputs.tag_name }} å‘å¸ƒ

          ${{ steps.tag_info.outputs.tag_message }}

          ### ğŸ“¦ å®‰è£…

          ```bash
          go get github.com/anhao/go-easy-sms@${{ steps.tag_info.outputs.tag_name }}
          ```

          ### ğŸš€ å¿«é€Ÿå¼€å§‹

          ```go
          package main

          import (
              "fmt"
              "log"

              "github.com/anhao/go-easy-sms"
              "github.com/anhao/go-easy-sms/config"
              "github.com/anhao/go-easy-sms/message"
          )

          func main() {
              // é…ç½®ä¿¡æ¯
              cfg := config.NewConfig()
              cfg.Timeout = 5.0
              cfg.DefaultGateways = []string{"yunpian", "aliyun"}

              cfg.GatewayConfigs = map[string]map[string]any{
                  "yunpian": {
                      "api_key":   "your-api-key",
                      "signature": "ã€é»˜è®¤ç­¾åã€‘",
                  },
                  "aliyun": {
                      "access_key_id":     "your-access-key-id",
                      "access_key_secret": "your-access-key-secret",
                      "sign_name":         "your-sign-name",
                  },
              }

              // åˆ›å»º EasySms å®ä¾‹
              sms := easysms.New(cfg)

              // å‘é€çŸ­ä¿¡
              results, err := sms.Send(
                  message.NewPhoneNumber("13800138000"),
                  message.NewMessage().
                      SetContent("æ‚¨çš„éªŒè¯ç ä¸º: 6379").
                      SetTemplate("SMS_001").
                      SetData(map[string]any{"code": "6379"}),
              )

              if err != nil {
                  log.Fatalf("Failed to send message: %v", err)
              }

              // å¤„ç†ç»“æœ
              for gateway, result := range results {
                  if result.Status == easysms.StatusSuccess {
                      fmt.Printf("Successfully sent message via %s\n", gateway)
                  } else {
                      fmt.Printf("Failed to send message via %s: %v\n", gateway, result.Error)
                  }
              }
          }
          ```

          ### ğŸ“‹ ç¯å¢ƒè¦æ±‚

          - Go 1.18+

          ### ğŸ¤ è´¡çŒ®

          æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

          ### ğŸ“„ è®¸å¯è¯

          MIT License
          EOF

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag_name }}
          name: ${{ steps.tag_info.outputs.tag_name }} - Go Easy SMS å‘å¸ƒ
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: é€šçŸ¥å‘å¸ƒæˆåŠŸ
        run: |
          echo "âœ… Release ${{ steps.tag_info.outputs.tag_name }} åˆ›å»ºæˆåŠŸï¼"
          echo "ğŸ”— æŸ¥çœ‹ Release: https://github.com/anhao/go-easy-sms/releases/tag/${{ steps.tag_info.outputs.tag_name }}"
